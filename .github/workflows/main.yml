name: Generate Stats Images

on:
  push:
    branches: [ master ]
  schedule:
    - cron: "5 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: generate-stats
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Check out repository under $GITHUB_WORKSPACE, so the job can access it
    - uses: actions/checkout@v3

    # Run using Python 3.10 for consistency and aiohttp
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        architecture: 'x64'
        cache: 'pip'

    # Install dependencies with `pip`
    - name: Install requirements
      run: |
        python3 -m pip install --upgrade pip setuptools wheel
        python3 -m pip install -r requirements.txt

    # Pull cache to detect previous state from output branch
    - name: Pull cache from output branch
      run: |
        mkdir -p .cache-runtime
        git fetch origin output || true
        git show origin/output:cache/stats.json > .cache-runtime/stats.json || true

    # Generate all statistics images
    - name: Generate images
      run: |
        python3 --version
        python3 generate_images.py
      env:
        ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        EXCLUDED_LANGS: ${{ secrets.EXCLUDED_LANGS }}
        EXCLUDE_FORKED_REPOS: true

    # Snap Generated Output
    - name: Snapshot generated artifacts
      run: |
        if [ ! -d generated ]; then
          echo "âŒ generated/ not found"
          exit 1
        fi

        TMP_DIR=$(mktemp -d)
        rsync -a generated/ "$TMP_DIR/generated/"
        echo "TMP_DIR=$TMP_DIR" >> $GITHUB_ENV

    # Publish generated to OUTPUT branch
    - name: Publish to output branch
      run: |
        git fetch origin

        if git show-ref --verify --quiet refs/remotes/origin/output; then
          git checkout -B output origin/output
        else
          git checkout --orphan output
          git rm -rf . >/dev/null 2>&1 || true
        fi

        mkdir -p generated
        rsync -a --delete "$TMP_DIR/generated/" generated/

        mkdir -p cache
        mv .cache-runtime/stats.json cache/stats.json 2>/dev/null || true

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add generated cache
        git commit -m "actions: update generated stats" || echo "No changes"
        git push origin output